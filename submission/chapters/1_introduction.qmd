---
title: "Introduction"
format:
  html:
    toc: true
---

We analyze the WHO [“Life Expectancy (WHO)” dataset](https://www.kaggle.com/datasets/kumarajarshi/life-expectancy-who), published on Kaggle [@KumarRajarshi]. The dataset merges longevity-related indicators from the WHO Global Health Observatory (GHO) with economic variables from the United Nations and provides a country-year panel for 193 countries over 2000–2015 (Table @tbl-intro-dataset-coverage). It consists of 22 columns: the target variable `life_expectancy` (years), as well as 20 candidate predictors spanning mortality burden, immunization coverage, socio-economic development, and nutrition [@KumarRajarshi]. Like many global indicator datasets, it exhibits systematic missingness, especially for `population`, `hepatitis_b`, and `gdp` [@KumarRajarshi]; we therefore document missing-value handling and sensitivity checks explicitly in Ch. 2.

Our overarching goal is **explanatory and predictive regression**: (i) identify which features matter for life expectancy (direction and magnitude), and (ii) quantify how well life expectancy can be predicted given the available features. Because the raw data is a longitudinal panel, we conduct regression analysis on a single cross‑section (2014) to avoid within‑country autocorrelation. For that cross‑section we retain broad coverage by **carry‑forward imputing predictors within each country** (last observation carried forward), and we keep rows even if some predictors remain missing. The complete‑case subset is then used for correlation and regression diagnostics in Ch. 3 and Ch. 5.
<!-- TODO: link to the respective files - i.e. [Label](file.qmd) -->

<!--  TODO: Do *not* start with an overview of missing values; Start with a description of the most important summary statistics, univariate plot of the life expectancy, life expectancy over the years; then most important predictors, as well as the overview of the columns / features (do not modify!)-->
```{python}
# | label: intro-setup
# | include: false
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

from ama_tlbx.data import LECol, LifeExpectancyDataset
from ama_tlbx.utils.plotting_config import DEFAULT_PLOT_CFG

np.random.seed(42)
DEFAULT_PLOT_CFG.apply_global()

# Raw longitudinal panel
le_panel = LifeExpectancyDataset.from_csv(
    aggregate_by_country=False,
    drop_missing_target=False,
    resolve_nand_pred=False,
)
df_panel = le_panel.df

# 2014 cross-section (carry-forward predictors; keep residual missingness)
le_xs_2014 = LifeExpectancyDataset.from_csv(
    aggregate_by_country=2014,
    drop_missing_target=True,
    resolve_nand_pred="carry_forward",
)
df_2014 = le_xs_2014.df
df_2014_cc = df_2014.dropna()
pred_cols = le_xs_2014.feature_columns(include_target=False)

# Basic dataset coverage
dataset_coverage = pd.DataFrame(
    [
        {
            "view": "Raw panel (no dropping)",
            "n_rows": len(df_panel),
            "n_countries": df_panel[LECol.COUNTRY].nunique(),
            "years": f"{df_panel[LECol.YEAR].dt.year.min()}–{df_panel[LECol.YEAR].dt.year.max()}",
        },
        {
            "view": "2014 cross-section (carry-forward predictors)",
            "n_rows": len(df_2014),
            "n_countries": df_2014.index.nunique(),
            "years": "2014",
        },
        {
            "view": "2014 complete-case subset (drop missing predictors)",
            "n_rows": len(df_2014_cc),
            "n_countries": df_2014_cc.index.nunique(),
            "years": "2014",
        },
    ],
)

# Missingness remaining after carry-forward (2014 cross-section)
# TODO: add n_missing_features!
rows_with_missing = int(df_2014[pred_cols].isna().any(axis=1).sum())
cross_section_missing = pd.DataFrame(
    {
        "n_rows": [len(df_2014)],
        "n_complete_cases": [len(df_2014_cc)],
        "n_rows_with_missing": [rows_with_missing],
        "share_missing_pct": [rows_with_missing / len(df_2014) * 100],
    }
)

# Missingness overview in the panel (top 8 predictors)
panel_missing = (
    df_panel[le_panel.feature_columns(include_target=False)]
    .isna()
    .agg(["sum", "mean"])
    .T.rename(columns={"sum": "missing_n", "mean": "missing_frac"})
    .assign(missing_pct=lambda d: d["missing_frac"] * 100)
    .sort_values("missing_pct", ascending=False)
    .head(8)
    .assign(feature=lambda d: d.index.map(le_panel.get_pretty_name))
)

# Life expectancy summary stats for the 2014 cross-section
life_expectancy_pretty = le_xs_2014.get_pretty_name(str(LECol.TARGET))
life_expectancy_stats = (
    df_2014[LECol.TARGET].describe().loc[["count", "mean", "std", "min", "max"]]
)
life_expectancy_stats.index = ["N", "Mean", "SD", "Min", "Max"]
life_expectancy_stats = life_expectancy_stats.to_frame(name=life_expectancy_pretty).T
life_expectancy_stats["N"] = life_expectancy_stats["N"].astype(int)

# Correlations with target (complete-case 2014 subset; computed via the toolbox analyzer)
corr_result_2014 = (
    le_xs_2014.make_correlation_analyzer(standardized=False, include_target=True)
    .fit()
    .result(top_n_pairs=200)
)
assert corr_result_2014.target_correlations is not None
target_corr_2014 = corr_result_2014.target_correlations.assign(
    pretty=lambda d: d.feature.map(le_xs_2014.get_pretty_name),
)

pos5 = target_corr_2014.head(5).assign(direction="Positive")
neg5 = target_corr_2014.tail(5).assign(direction="Negative")
top_corr_2014 = (
    pd.concat([neg5, pos5], ignore_index=True)
    .assign(correlation=lambda d: d.correlation.astype(float))
    .sort_values("correlation")
)

# Multicollinearity hotspots referenced in text
hotspot_pairs = [
    (LECol.INFANT_DEATHS, LECol.UNDER_FIVE_DEATHS),
    (LECol.GDP, LECol.PERCENTAGE_EXPENDITURE),
    (LECol.THINNESS_5_9_YEARS, LECol.THINNESS_1_19_YEARS),
    (LECol.HDI, LECol.SCHOOLING),
]
collinearity_hotspots = pd.DataFrame(
    [
        {
            "pair": f"`{str(a)}`–`{str(b)}`",
            "pretty_pair": f"{le_xs_2014.get_pretty_name(str(a))} vs {le_xs_2014.get_pretty_name(str(b))}",
            "correlation": float(corr_result_2014.matrix.loc[str(a), str(b)]),
        }
        for a, b in hotspot_pairs
    ],
).sort_values("correlation", ascending=False)


# Helper: map per-column transforms to readable labels for the report
def _transform_label(feature: str) -> str:
    try:
        col = LECol(feature)
    except ValueError:
        return "custom"

    transform = col.metadata().transform
    if transform is None:
        return "none"

    name = getattr(transform, "__name__", "custom")
    if name == "_log1p_under_coverage":
        return "log1p(100 - x)"
    if name == "log1p":
        return "log1p(x)"
    if name == "_status_dummies":
        return "dummy (developed=1)"
    return name


def _parse_column_docstrings(doc: str) -> pd.DataFrame:
    rows: list[dict[str, str]] = []
    for raw_line in (doc or "").splitlines():
        line = raw_line.strip()
        if not line.startswith("- ``") or " - " not in line:
            continue
        left, desc = line.split(" - ", 1)
        name_part, dtype_part = left.split(": ", 1)
        name = name_part.replace("- ``", "").replace("``", "").strip()
        rows.append(
            {"column": name, "type": dtype_part.strip(), "description": desc.strip()}
        )
    return pd.DataFrame(rows)


column_glossary = (
    _parse_column_docstrings(LECol.__doc__ or "")
    .assign(pretty=lambda d: d.column.map(le_xs_2014.get_pretty_name))
    .assign(transform=lambda d: d.column.map(_transform_label))
)
column_glossary.loc[column_glossary["column"] == str(LECol.STATUS), "description"] = (
    "Development status (0 = Developing, 1 = Developed)"
)
```

```{python}
# | label: tbl-intro-dataset-coverage
# | tbl-cap: "Dataset coverage summary (raw panel, 2014 cross-section, complete-case subset)."
dataset_coverage.style.hide(axis="index")
```

```{python}
# | label: tbl-intro-cross-section-missing
# | tbl-cap: "Remaining predictor missingness after carry-forward (2014 cross-section)."
cross_section_missing.assign(
    **{"share_missing_pct": lambda d: d["share_missing_pct"].round(1)}
).style.hide(axis="index")
```

```{python}
# | label: tbl-intro-panel-missing
# | tbl-cap: "Top predictors by missingness in the full panel (2000–2015; counts and %)."
panel_missing.assign(
    missing_pct=lambda d: d["missing_pct"].round(1),
).loc[:, ["feature", "missing_n", "missing_pct"]].rename(
    columns={"feature": "Feature", "missing_n": "Missing (n)", "missing_pct": "Missing (%)"}
).style.hide(axis="index")
```

Table @tbl-intro-dataset-coverage summarizes sample sizes. The raw panel contains 2,938 country‑year samples across 193 countries (2000–2015). In 2014, carry‑forward imputation retains $n=183$ countries; 50 still have at least one missing predictor (Table @tbl-intro-cross-section-missing), leaving a complete‑case subset of $n=133$ used for correlation and regression diagnostics (Ch. 3–5). Missingness is concentrated in a small set of predictors (Table @tbl-intro-panel-missing), motivating the preprocessing choices documented in Ch. 2.

<!-- TODO: rename section title -->
# Descriptive snapshot (2014 cross-section)

```{python}
# | label: tbl-intro-lifeexp-summary
# | tbl-cap: "Life expectancy summary statistics (2014 cross-section; carry-forward predictors)."
life_expectancy_stats.round(2)
```

```{python}
# | label: fig-intro-lifeexp-dist
# | fig-cap: "Life expectancy distribution in the 2014 cross-section (carry-forward predictors)."
fig, ax = plt.subplots(figsize=(8, 4))
sns.histplot(
    df_2014[LECol.LIFE_EXPECTANCY],
    kde=True,
    ax=ax,
    color="steelblue",
    edgecolor="black",
)
ax.set_xlabel(LECol.LIFE_EXPECTANCY.pretty_name)
ax.set_ylabel("Count")
ax.set_title("Life Expectancy (2014)")
plt.tight_layout()
plt.show()
```

Figure @fig-intro-lifeexp-dist reinforces the summary statistics in Table @tbl-intro-lifeexp-summary: in 2014 ($n=183$), mean life expectancy is 71.5 years (SD 8.6; range 48.1–89.0), and the distribution is unimodal with a noticeable left tail. The lower tail signals a subset of countries with markedly shorter lifespans, motivating stratified interpretation when comparing country profiles later in the report.

## Outcome and predictors

All variables are reported at the country‑year level and come in mixed scales (counts, rates, percentages, and economic magnitudes). The target variable is `life_expectancy` (years). Predictors span four conceptual blocks:

1. **Demography & mortality**
   - **Adult Mortality (per 1000):** adult mortality rate per 1,000 population (probability of dying between ages 15 and 60).
   - **Infant Deaths (per 1000):** number of infant deaths per 1,000 population.
   - **Under‑5 Deaths (per 1000):** deaths of children under 5 per 1,000 population.
   - **HIV/AIDS Deaths (per 1000 births):** deaths per 1,000 live births due to HIV/AIDS (ages 0–4).
   - **Population:** total population of the country.

2. **Immunization & infectious disease burden**
   - **Hepatitis B Coverage (%):** HepB immunization coverage among 1‑year‑olds (%).
   - **Polio Coverage (%):** polio immunization coverage among 1‑year‑olds (%).
   - **Diphtheria Coverage (%):** DTP3 immunization coverage among 1‑year‑olds (%).
   - **Measles Cases (per 1000):** number of measles cases per 1,000 population.

3. **Socio‑economic & investment**
   - **GDP per Capita (USD):** gross domestic product per capita (USD).
   - **Health Expenditure (% of GDP per capita):** health spending as a percentage of GDP per capita.
   - **Total Health Expenditure (% of govt expenditure):** government health expenditure as a percentage of total government spending.
   - **Income composition of resources** or **Human Development Index (0–1):** socio‑economic development proxy; see [Investigate HDI](2_investigate_hdi.qmd) for details.
   - **Schooling (years):** average years of schooling.
   - **Alcohol Consumption (liters per capita):** recorded per‑capita (15+) consumption in liters of pure alcohol.


4. **Nutrition & development status**
   - **BMI (Average):** average body‑mass index.
   - **Thinness 10–19 Years (%):** prevalence of thinness among children ages 10–19 (%).
   - **Thinness 5–9 Years (%):** prevalence of thinness among children ages 5–9 (%).
   - **Development Status:** categorical indicator (`0 = Developing`, `1 = Developed`).


::: {.callout-note collapse="true"}
## Column glossary (from `LifeExpectancyColumn`)

The table below summarizes column meanings and the default transforms applied later in the pipeline (`tf_and_norm`).

```{python}
# | label: tbl-intro-column-glossary
# | tbl-cap: "Column definitions and default preprocessing transforms."
column_glossary.loc[:, ["pretty", "description", "transform"]].rename(
    columns={
        "pretty": "Feature",
        "description": "Definition (units / scale)",
        "transform": "Default transform",
    },
).style.hide(axis="index")

```
:::

# Descriptive signal (2014 cross‑section, complete‑case subset)

For bivariate correlations we restrict to the complete‑case subset ($n=133$) because Pearson correlation is defined on rows without missing values. Pearson correlations are scale‑invariant, so the coefficients below are unchanged by z‑scoring. The strongest *positive* linear associations with life expectancy are development and human‑capital indicators (income composition/HDI and schooling), while the strongest *negative* associations are mortality and burden indicators (adult mortality, HIV/AIDS, thinness). Because the income‑composition/HDI variable is potentially tied to life expectancy by construction, we treat it as a descriptive development proxy and interpret it cautiously in multivariate regression.

```{python}
# | label: fig-intro-top-corr
# | fig-cap: "Top 5 positive and negative correlations with life expectancy (2014 complete-case subset)."

fig, ax = plt.subplots(figsize=(8, 5))
sns.barplot(
    data=top_corr_2014,
    x="correlation",
    y="pretty",
    hue="direction",
    order=top_corr_2014.sort_values("correlation")["pretty"].tolist(),
    dodge=False,
    palette="coolwarm",
    ax=ax,
)
ax.axvline(0, color="black", linewidth=1)
ax.set_xlabel(f"Correlation with {LECol.LIFE_EXPECTANCY.pretty_name}")
ax.set_ylabel("")
ax.set_title("Strongest Linear Associations")
ax.legend(title="")
plt.tight_layout()
plt.show()
```

```{python}
# | label: tbl-intro-top-corr
# | tbl-cap: "Top 5 positive and negative correlations with life expectancy (2014 complete-case subset)."
top_corr_2014.assign(r=lambda d: d.correlation.round(2)).loc[:, ["pretty", "r"]].rename(
    columns={"pretty": "Feature", "r": "Correlation (r)"},
).style.hide(axis="index")
```

In the complete‑case subset, the largest positive associations are with income composition/HDI ($r \approx 0.89$) and schooling ($r \approx 0.79$), followed by BMI and alcohol consumption. The largest negative associations are with adult mortality ($r \approx -0.77$) and HIV/AIDS deaths ($r \approx -0.61$), with thinness indicators also strongly negative (Table @tbl-intro-top-corr). These are descriptive and do not control for confounding; the alcohol association likely reflects broader development differences rather than a causal protective effect. The full correlation structure and transform sensitivity are analyzed in Ch. 3.

Several predictors are also *highly correlated with each other*, which motivates either feature grouping (PCA blocks) or careful interpretation of multivariate regression coefficients.

```{python}
# | label: tbl-intro-collinearity-hotspots
# | tbl-cap: "Selected multicollinearity hotspots (pairwise Pearson correlations; 2014 complete-case subset)."
collinearity_hotspots.assign(r=lambda d: d.correlation.round(3)).loc[
    :, ["pretty_pair", "r"]
].rename(
    columns={"pretty_pair": "Pair", "r": "Correlation (r)"},
).style.hide(axis="index")
```

Several predictor pairs are near‑redundant: infant deaths vs under‑5 deaths ($r \approx 0.995$), GDP vs health expenditure ($r \approx 0.95$), thinness 5–9 vs 10–19 ($r \approx 0.94$), and income composition/HDI vs schooling ($r \approx 0.91$). These collinear blocks motivate grouped PCA in Ch. 3 and careful interpretation of regression coefficients in Ch. 5.

# Development status gap (2014 cross-section)

```{python}
# | label: fig-intro-status-gap
# | fig-cap: "Life expectancy by development status (2014 cross-section; carry-forward predictors)."
plot_df = df_2014.assign(
    status_label=lambda d: d[LECol.STATUS].map({0: "Developing", 1: "Developed"}),
)

order = ["Developing", "Developed"]
status_stats = (
    plot_df.groupby("status_label", observed=True)[LECol.LIFE_EXPECTANCY]
    .agg(n="count", mean="mean", std="std", median="median", max="max")
    .reindex(order)
)

fig, ax = plt.subplots(figsize=(7, 4))
sns.boxplot(
    data=plot_df,
    x="status_label",
    y=LECol.LIFE_EXPECTANCY,
    ax=ax,
    color="lightgray",
    order=order,
)
sns.stripplot(
    data=plot_df,
    x="status_label",
    y=LECol.LIFE_EXPECTANCY,
    ax=ax,
    color="steelblue",
    alpha=0.6,
    jitter=True,
    size=4,
    order=order,
)
ax.set_xlabel("")
ax.set_ylabel(LECol.LIFE_EXPECTANCY.pretty_name)
ax.set_title("Development Status Gap")

ymin, ymax = ax.get_ylim()
offset = 0.03 * (ymax - ymin)
for i, label in enumerate(order):
    mean = status_stats.loc[label, "mean"]
    std = status_stats.loc[label, "std"]
    y = status_stats.loc[label, "max"] + offset
    ax.text(
        i,
        y,
        f"mean={mean:.2f}\nstd={std:.2f}",
        ha="center",
        va="bottom",
        fontsize=9,
        color="black",
    )

plt.tight_layout()
plt.show()

```

```{python}
# | label: tbl-intro-status-stats
# | tbl-cap: "Life expectancy by development status (2014 cross-section; carry-forward predictors)."
status_stats.loc[:, ["n", "mean", "std", "median"]].rename_axis("Status").style.format(
    {"mean": "{:.2f}", "std": "{:.2f}", "median": "{:.2f}"}
)
```

Developed countries have markedly higher life expectancy in 2014: the mean is about 81.1 years (SD 4.2, $n=32$) versus 69.5 years (SD 7.8, $n=151$) for developing countries (Table @tbl-intro-status-stats). Figure @fig-intro-status-gap shows that while the distributions overlap, the developed‑country distribution is shifted upward and tighter, indicating a gap of roughly 11.6 years and motivating development status as a key stratifying variable in later analyses (Ch. 3–5).

# Research questions

The course requirements ask us to answer two core questions: **which features matter** for the target and **how well** the target can be predicted. Motivated by the dataset description [@KumarRajarshi], we operationalize this as:

1. **Feature importance (explanatory):** Which predictors show the strongest associations with life expectancy, and which remain important in multivariate OLS once correlated development indicators are controlled? (effect sizes, uncertainty, $R^2$)
2. **Prediction (generalization):** How accurately can life expectancy be predicted from the available predictors? We compare parsimonious vs richer models using a year-based holdout and cross-validation (RMSE/$R^2$).
3. **Incremental value of immunization:** Do immunization variables (HepB/Polio/DTP3) add explanatory or predictive value beyond socio-economic development proxies (income composition, schooling, GDP) and mortality burden? [@KumarRajarshi]
4. **Nonlinearity and effect modification:** Are there motivated nonlinearities or interactions (e.g., differences by development status; diminishing returns of expenditure-related predictors) that improve fit and remain interpretable?
5. **Collinearity, PCA, and robustness:** Can grouped PCA mitigate multicollinearity without degrading predictive performance, and how sensitive are conclusions to outliers and preprocessing choices?
6. **Country profiles (clustering):** Do countries cluster into distinct multivariate profiles in standardized feature space, and how do these profiles relate to life expectancy?

<!-- TODO: merge Analytics flow and Roadmap! -->
# Analytical flow

1. **Preprocessing:** header normalization, type conversion, year selection, transforms for skewed predictors, and z‑scoring of numeric predictors; documented missing‑value and outlier handling.
2. **Exploration:** correlation structure and grouped PCA to quantify redundancy and dominant dimensions.
3. **Modelling:** baseline univariate OLS, core multivariate OLS, assumption diagnostics, CV; grouped PCA + regression to mitigate multicollinearity.
4. **Interpretation:** effect sizes with uncertainty, practical relevance, and stated limitations.

# Roadmap

Preprocessing & year selection/outliers (Ch. 2) $\rightarrow$ correlation & PCA (Ch. 3) $\rightarrow$ clustering (Ch. 4) $\rightarrow$ regression (Ch. 5). Each chapter cites the generating notebook(s) for figures/tables to keep provenance explicit.
